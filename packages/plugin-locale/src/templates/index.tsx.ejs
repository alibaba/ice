<% if(!hasJsxRuntime) { %>
  import * as React from 'react';
<% } %>
import { createContext, useContext, useState } from 'react';
import { history } from 'create-app-shared';
import Cookies from 'universal-cookie';

const LOCALE_COOKIE_KEY = '<%= LOCALE_COOKIE_KEY %>';

const Context = createContext<any>(null);

export const LocaleProvider = ({ children }) => {
  const [activeLocale, setActiveLocale] = useState<string>(() => getLocale());

  function setLocale(locale: string) {
    setLocaleToCookies(locale);
    setActiveLocale(locale);
  }

  return (
    <Context.Provider value={[activeLocale, setLocale]}>
      {children}
    </Context.Provider>
  )
}

export function useLocale(): [string, React.Dispatch<React.SetStateAction<string>>] {
  return useContext(Context)
}

export function getDefaultLocale(): string {
  return '<%= defaultLocale %>'
}

export function getAllLocales(): string[] {
  return <%- JSON.stringify(locales) %>
}

function getDetectedLocaleFromPath(locales: string[]) {
  if (history === null) {
    console.log('history is null, can\'t get current locale from pathname');
    return;
  }
  const { location: { pathname } } = history;
  const pathnameParts = pathname.split('/').filter(pathnamePart => pathnamePart);

  let detectedLocale: string | undefined;

  // eslint-disable-next-line no-restricted-syntax
  for (const locale of locales) {
    if (pathnameParts[0] === locale) {
      detectedLocale = locale;
      break;
    }
  }

  return detectedLocale;
}

export function getLocale(): string {
  return new Cookies().get(LOCALE_COOKIE_KEY) ||
    <% if (localeRoute !== false) {%>
      getDetectedLocaleFromPath(<%- JSON.stringify(locales) %>) ||
    <% } %>
    '<%= defaultLocale %>'
}

function setLocaleToCookies(locale: string) {
  const cookies = new Cookies();
  cookies.set(LOCALE_COOKIE_KEY, locale, { path: '/' });
}
